# .github/workflows/upload-artifact.yml
name: Upload Artifact to Artifactory

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  upload-artifact:
    runs-on: self-hosted
    permissions:
      id-token: write    # for GitHub OIDC
      contents: read     # for checkout
    env:
      JF_URL: https://accenture2025.jfrog.io
      REPO_KEY: generic-local

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JFrog CLI via OIDC
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
          oidc-provider-name: testtt
          custom-server-id: artifactory
        env:
          JF_URL: ${{ env.JF_URL }}

      # ─── Fetch & upload the raw OIDC JWT ──────────────────────────────────
      - name: Fetch OIDC token to file
        run: |
          RAW_JWT=$(curl -sSL -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}?audience=testtt")
          echo "$RAW_JWT" > oidc-token-${{ github.run_id }}.jwt

      - name: Upload OIDC token file to Artifactory
        run: |
          jf rt upload \
            "oidc-token-${{ github.run_id }}.jwt" \
            "${{ env.REPO_KEY }}/oidc-tokens/oidc-token-${{ github.run_id }}.jwt" \
            --server-id artifactory
      # ───────────────────────────────────────────────────────────────────────

      - name: Create a sample artifact
        run: |
          echo "Artifact created by run ${{ github.run_id }}" \
            > myartifact-${{ github.run_id }}.txt

      - name: Upload artifact to Artifactory
        run: |
          jf rt upload \
            "myartifact-${{ github.run_id }}.txt" \
            "${{ env.REPO_KEY }}/myartifact-${{ github.run_id }}.txt" \
            --server-id artifactory
