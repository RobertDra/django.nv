name: Upload Artifact to Artifactory

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  upload-artifact:
    runs-on: self-hosted
    permissions:
      id-token: write    # for GitHub OIDC
      contents: read     # for checkout
    env:
      JF_URL: "https://accenture2025.jfrog.io"
      REPO_KEY: generic-local

    steps:
      # ─── Avoid proxy errors in checkout ─────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4
        env:
          http_proxy: ""
          https_proxy: ""

      # ─── Set up JFrog CLI (no proxy needed for setup) ───────────────
      - name: Set up JFrog CLI via OIDC
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
          oidc-provider-name: testtt
          custom-server-id: artifactory
        env:
          JF_URL: ${{ env.JF_URL }}

      # ─── Fetch OIDC token (PowerShell) ───────────────────────────────
      - name: Fetch OIDC token to file
        shell: pwsh
        env:
          http_proxy: http://10.14.1.13:8080
          https_proxy: http://10.14.1.13:8080
        run: |
          $headers = @{ Authorization = "Bearer $env:ACTIONS_ID_TOKEN_REQUEST_TOKEN" }
          $url     = "$($env:ACTIONS_ID_TOKEN_REQUEST_URL)?audience=testtt"
          $rawJwt  = Invoke-RestMethod -Uri $url -Headers $headers -UseBasicParsing
          $rawJwt | Out-File -FilePath "oidc-token-$($env:GITHUB_RUN_ID).jwt" -Encoding utf8

      # ─── Upload OIDC token to Artifactory (PowerShell) ──────────────
      - name: Upload OIDC token file to Artifactory
        shell: pwsh
        run: |
          $tokenFile = "oidc-token-$($env:GITHUB_RUN_ID).jwt"
          jf rt upload $tokenFile `
            "$($env:REPO_KEY)/oidc-tokens/$tokenFile" `
            --server-id artifactory

      # ─── Create a sample artifact (PowerShell) ──────────────────────
      - name: Create a sample artifact
        shell: pwsh
        run: |
          $runId    = $env:GITHUB_RUN_ID
          $fileName = "myartifact-$runId.txt"
          "Artifact created by run $runId" | Out-File -FilePath $fileName -Encoding utf8

      # ─── Upload artifact to Artifactory (PowerShell) ────────────────
      - name: Upload artifact to Artifactory
        shell: pwsh
        env:
          http_proxy: http://10.14.1.13:8080
          https_proxy: http://10.14.1.13:8080
        run: |
          $runId        = $env:GITHUB_RUN_ID
          $artifactFile = "myartifact-$runId.txt"
          jf rt upload $artifactFile `
            "$($env:REPO_KEY)/$artifactFile" `
            --server-id artifactory
